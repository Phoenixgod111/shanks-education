name: ðŸš€ Deploy to Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Shanks Education
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          password: ${{ secrets.SERVER_PASS }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 15s
          script: |
            echo "ðŸ” Testing SSH connection..."
            echo "ðŸ“ Server: ${{ secrets.SERVER_HOST }}"
            echo "ðŸ‘¤ User: ${{ secrets.SERVER_USER }}"
            echo "ðŸ“ Current directory: $(pwd)"
            echo "ðŸ–¥ï¸  OS: $(uname -a)"
            echo "âœ… SSH connection successful!"

      - name: ðŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          password: ${{ secrets.SERVER_PASS }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          script: |
            echo "ðŸš€ Starting deployment of Shanks Education..."
            echo "ðŸ“ Current directory: $(pwd)"
            echo "ðŸ‘¤ Current user: $(whoami)"

            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            echo "ðŸ“ Changing to project directory..."
            if [ ! -d "/var/www/shanks-education" ]; then
                echo "âŒ Directory /var/www/shanks-education does not exist"
                echo "ðŸ“ Available directories in /var/www/:"
                ls -la /var/www/ 2>/dev/null || echo "Cannot list /var/www/"
                exit 1
            fi

            cd /var/www/shanks-education || {
                echo "âŒ Failed to change to /var/www/shanks-education"
                echo "ðŸ“ Current directory: $(pwd)"
                echo "ðŸ‘¤ Current user: $(whoami)"
                ls -la /var/www/
                exit 1
            }
            echo "âœ… Successfully changed to project directory"

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
            if [ ! -d ".git" ]; then
                echo "âŒ This is not a git repository!"
                ls -la
                exit 1
            fi
            echo "âœ… Git repository found"

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ git ÑÑ‚Ð°Ñ‚ÑƒÑ
            echo "ðŸ“Š Current git status:"
            git status --porcelain || echo "âš ï¸ Git status failed"
            git log --oneline -3 || echo "âš ï¸ Git log failed"

            # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ
            echo "ðŸ” Detecting main branch..."
            if git show-ref --verify --quiet refs/remotes/origin/main; then
                MAIN_BRANCH="main"
                echo "âœ… Using branch: main"
            elif git show-ref --verify --quiet refs/remotes/origin/master; then
                MAIN_BRANCH="master"
                echo "âœ… Using branch: master"
            else
                echo "âŒ No main or master branch found in origin"
                git branch -r
                exit 1
            fi

            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· GitHub
            echo "ðŸ“¥ Updating code from GitHub branch: $MAIN_BRANCH..."
            git fetch origin || {
                echo "âŒ Git fetch failed"
                exit 1
            }

            git reset --hard origin/$MAIN_BRANCH || {
                echo "âŒ Git reset failed"
                exit 1
            }

            git clean -fd || echo "âš ï¸ Git clean failed"
            echo "âœ… Code updated successfully"

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð°
            echo "ðŸ”§ Setting correct permissions..."
            sudo chown -R www-data:www-data /var/www/shanks-education 2>/dev/null || {
                echo "âš ï¸ chown failed, trying without sudo..."
                chown -R www-data:www-data /var/www/shanks-education 2>/dev/null || echo "âš ï¸ chown failed completely"
            }

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð¿Ð°Ð¿ÐºÐ¸ subjects
            echo "ðŸ”§ Setting subjects permissions..."
            sudo chmod -R 755 subjects/ 2>/dev/null || chmod -R 755 subjects/ 2>/dev/null || echo "âš ï¸ chmod failed"

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
            echo "ðŸ” Checking nginx configuration..."
            if sudo nginx -t 2>/dev/null; then
                echo "âœ… Nginx config is valid"
            else
                echo "âŒ Nginx config has errors"
                sudo nginx -T 2>/dev/null || echo "âš ï¸ Cannot show nginx config"
            fi

            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ nginx Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
            echo "ðŸ”„ Reloading nginx..."
            if sudo systemctl reload nginx 2>/dev/null; then
                echo "âœ… Nginx reloaded successfully"
            else
                echo "âš ï¸ Nginx reload failed, trying restart..."
                sudo systemctl restart nginx 2>/dev/null || {
                    echo "âŒ Nginx restart failed"
                    exit 1
                }
            fi

            # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
            echo "â³ Waiting for nginx to apply changes..."
            sleep 3

            # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ°Ð¹Ñ‚Ð°
            echo "ðŸŒ Testing website..."
            for i in {1..3}; do
                echo "Attempt $i/3..."
                RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://localhost 2>/dev/null || echo "000")
                if [ "$RESPONSE" = "200" ]; then
                    echo "âœ… Website is UP (HTTP $RESPONSE)"
                    break
                else
                    echo "âš ï¸ Attempt $i failed (HTTP $RESPONSE)"
                    if [ $i -eq 3 ]; then
                        echo "âŒ Website is DOWN after 3 attempts (HTTP $RESPONSE)"
                        exit 1
                    fi
                    sleep 2
                fi
            done

            echo ""
            echo "ðŸŽ‰ Deployment completed successfully!"
            echo "ðŸŒ Site available at: http://${{ secrets.SERVER_HOST }}"
            echo "ðŸ“Š Deployment finished at: $(date)"

      - name: ðŸ” Run Server Diagnostic (on failure)
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          password: ${{ secrets.SERVER_PASS }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 30s
          script: |
            echo "ðŸ” Running server diagnostic due to deployment failure..."
            if [ -f "/var/www/shanks-education/server-diagnostic.sh" ]; then
                bash /var/www/shanks-education/server-diagnostic.sh
            else
                echo "âŒ Diagnostic script not found on server"
                echo "ðŸ“ Current directory: $(pwd)"
                echo "ðŸ‘¤ Current user: $(whoami)"
                echo "ðŸ–¥ï¸  OS: $(uname -a)"
                echo "ðŸ“ Checking /var/www/:"
                ls -la /var/www/ 2>/dev/null || echo "Cannot list /var/www/"
            fi