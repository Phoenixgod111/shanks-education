name: üöÄ Deploy to Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Shanks Education
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üöÄ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          password: ${{ secrets.SERVER_PASS }}  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è –∫–ª—é—á–∞
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 30s
          script: |
            echo "üöÄ Starting deployment of Shanks Education..."

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /var/www/shanks-education

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º git —Å—Ç–∞—Ç—É—Å
            echo "üìä Current git status:"
            git status --porcelain
            git log --oneline -5

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub
            echo "üì• Updating code from GitHub..."
            git fetch origin main
            git checkout main
            git pull origin main --no-edit

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
            echo "üìÅ Files updated:"
            git diff --name-only HEAD~1

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
            echo "üîß Setting correct permissions..."
            sudo chown -R www-data:www-data /var/www/shanks-education

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            echo "üîç Checking nginx configuration..."
            sudo nginx -t

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            echo "üîÑ Reloading nginx..."
            sudo systemctl reload nginx

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "‚úÖ Checking deployment status..."
            sudo systemctl status nginx --no-pager -l | head -10

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
            echo "üíæ Disk usage:"
            df -h /var/www | tail -1

            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–π—Ç–∞
            echo "üåê Testing website..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
            if [ "$RESPONSE" = "200" ]; then
                echo "‚úÖ Website is UP (HTTP $RESPONSE)"
            else
                echo "‚ùå Website is DOWN (HTTP $RESPONSE)"
                exit 1
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞
            echo "üìè Project size:"
            du -sh /var/www/shanks-education

            echo ""
            echo "üéâ Deployment completed successfully!"
            echo "üåê Site available at: http://${{ secrets.SERVER_HOST }}"