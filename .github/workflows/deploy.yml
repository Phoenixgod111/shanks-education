name: üöÄ Deploy to Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Shanks Education
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîç Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          password: ${{ secrets.SERVER_PASS }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 15s
          script: |
            echo "üîç Testing SSH connection..."
            echo "üìç Server: ${{ secrets.SERVER_HOST }}"
            echo "üë§ User: ${{ secrets.SERVER_USER }}"
            echo "üìÅ Current directory: $(pwd)"
            echo "üñ•Ô∏è  OS: $(uname -a)"
            echo "‚úÖ SSH connection successful!"

      - name: üöÄ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          password: ${{ secrets.SERVER_PASS }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          script: |
            echo "üöÄ Starting deployment of Shanks Education..."
            echo "üìç Current directory: $(pwd)"
            echo "üë§ Current user: $(whoami)"

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            echo "üìÅ Changing to project directory..."
            if [ ! -d "/var/www/shanks-education" ]; then
                echo "‚ùå Directory /var/www/shanks-education does not exist"
                echo "üìÅ Available directories in /var/www/:"
                ls -la /var/www/ 2>/dev/null || echo "Cannot list /var/www/"
                exit 1
            fi

            cd /var/www/shanks-education || {
                echo "‚ùå Failed to change to /var/www/shanks-education"
                echo "üìÅ Current directory: $(pwd)"
                echo "üë§ Current user: $(whoami)"
                ls -la /var/www/
                exit 1
            }
            echo "‚úÖ Successfully changed to project directory"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ ! -d ".git" ]; then
                echo "‚ùå This is not a git repository!"
                ls -la
                exit 1
            fi
            echo "‚úÖ Git repository found"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º git —Å—Ç–∞—Ç—É—Å
            echo "üìä Current git status:"
            git status --porcelain || echo "‚ö†Ô∏è Git status failed"
            git log --oneline -3 || echo "‚ö†Ô∏è Git log failed"

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É
            echo "üîç Detecting main branch..."
            if git show-ref --verify --quiet refs/remotes/origin/main; then
                MAIN_BRANCH="main"
                echo "‚úÖ Using branch: main"
            elif git show-ref --verify --quiet refs/remotes/origin/master; then
                MAIN_BRANCH="master"
                echo "‚úÖ Using branch: master"
            else
                echo "‚ùå No main or master branch found in origin"
                git branch -r
                exit 1
            fi

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub
            echo "üì• Updating code from GitHub branch: $MAIN_BRANCH..."
            git fetch origin || {
                echo "‚ùå Git fetch failed"
                exit 1
            }

            git reset --hard origin/$MAIN_BRANCH || {
                echo "‚ùå Git reset failed"
                exit 1
            }

            git clean -fd || echo "‚ö†Ô∏è Git clean failed"
            echo "‚úÖ Code updated successfully"

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
            echo "üîß Setting correct permissions..."
            sudo chown -R www-data:www-data /var/www/shanks-education 2>/dev/null || {
                echo "‚ö†Ô∏è chown failed, trying without sudo..."
                chown -R www-data:www-data /var/www/shanks-education 2>/dev/null || echo "‚ö†Ô∏è chown failed completely"
            }

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –ø–∞–ø–∫–∏ subjects
            echo "üîß Setting subjects permissions..."
            sudo chmod -R 755 subjects/ 2>/dev/null || chmod -R 755 subjects/ 2>/dev/null || echo "‚ö†Ô∏è chmod failed"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            echo "üîç Checking nginx configuration..."
            if sudo nginx -t 2>/dev/null; then
                echo "‚úÖ Nginx config is valid"
            else
                echo "‚ùå Nginx config has errors"
                sudo nginx -T 2>/dev/null || echo "‚ö†Ô∏è Cannot show nginx config"
            fi

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            echo "üîÑ Reloading nginx..."
            if sudo systemctl reload nginx 2>/dev/null; then
                echo "‚úÖ Nginx reloaded successfully"
            else
                echo "‚ö†Ô∏è Nginx reload failed, trying restart..."
                sudo systemctl restart nginx 2>/dev/null || {
                    echo "‚ùå Nginx restart failed"
                    exit 1
                }
            fi

            # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            echo "‚è≥ Waiting for nginx to apply changes..."
            sleep 3

            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–π—Ç–∞
            echo "üåê Testing website..."
            for i in {1..3}; do
                echo "Attempt $i/3..."
                RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://localhost 2>/dev/null || echo "000")
                if [ "$RESPONSE" = "200" ]; then
                    echo "‚úÖ Website is UP (HTTP $RESPONSE)"
                    break
                else
                    echo "‚ö†Ô∏è Attempt $i failed (HTTP $RESPONSE)"
                    if [ $i -eq 3 ]; then
                        echo "‚ùå Website is DOWN after 3 attempts (HTTP $RESPONSE)"
                        exit 1
                    fi
                    sleep 2
                fi
            done

            echo ""
            echo "üéâ Deployment completed successfully!"
            echo "üåê Site available at: http://${{ secrets.SERVER_HOST }}"
            echo "üìä Deployment finished at: $(date)"