name: ğŸš€ Auto Deploy & Integrate
on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - 'trigger-deploy.txt'
  workflow_dispatch:
    inputs:
      run_integration:
        description: 'Run data integration'
        required: false
        default: 'false'
  workflow_dispatch:
    inputs:
      run_integration:
        description: 'Run data integration'
        required: false
        default: 'false'

jobs:
  deploy:
    name: Deploy & Integrate
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy & Auto-Integrate
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASS }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          script: |
            echo "ğŸš€ Starting automated deployment..."

            # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
            cd /var/www/shanks-education

            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
            CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")

            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´
            echo "ğŸ“¥ Updating code from GitHub..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
            NEW_COMMIT=$(git rev-parse HEAD)
            if [ "$CURRENT_COMMIT" != "$NEW_COMMIT" ]; then
                echo "ğŸ“Š Code updated: $CURRENT_COMMIT â†’ $NEW_COMMIT"

                # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
                if [ -f "full_math_integration.sh" ]; then
                    echo "ğŸ”§ Running full math integration..."
                    bash full_math_integration.sh
                fi

                # Ğ˜Ñ‰ĞµĞ¼ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
                if ls integration-scripts/*.sh 2>/dev/null; then
                    echo "ğŸ”§ Running additional integration scripts..."
                    for script in integration-scripts/*.sh; do
                        if [ -x "$script" ]; then
                            echo "Running $script..."
                            bash "$script"
                        fi
                    done
                fi

                # Ğ˜Ñ‰ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ .sh Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² ĞºĞ¾Ñ€Ğ½Ğµ
                find . -maxdepth 1 -name "*.sh" -executable | grep -v "full_math_integration.sh" | while read script; do
                    echo "ğŸ”§ Running $script..."
                    bash "$script"
                done
            else
                echo "ğŸ“Š No code changes detected"
            fi

            # Ğ’ÑĞµĞ³Ğ´Ğ° ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ°
            echo "ğŸ”§ Setting permissions..."
            sudo chown -R www-data:www-data /var/www/shanks-education
            sudo chmod -R 755 subjects/ 2>/dev/null || true

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ nginx
            echo "ğŸ” Checking nginx config..."
            sudo nginx -t

            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
            echo "ğŸ”„ Reloading nginx..."
            sudo systemctl reload nginx

            # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
            echo "ğŸŒ Testing website..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost 2>/dev/null || echo "000")
            if [ "$RESPONSE" = "200" ]; then
                echo "âœ… Website is UP (HTTP $RESPONSE)"
            else
                echo "âŒ Website is DOWN (HTTP $RESPONSE)"
                exit 1
            fi

            echo ""
            echo "ğŸ‰ Auto-deployment completed successfully!"
            echo "ğŸŒ Site: http://${{ secrets.HOST }}"

      - name: ğŸ“Š Deployment Report
        if: always()
        run: |
          echo "ğŸš€ Deployment finished at $(date)"
          echo "ğŸ“Š Status: ${{ job.status }}"
          echo "ğŸ”— Check: https://github.com/Phoenixgod111/shanks-education/actions"